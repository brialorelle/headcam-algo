---
title: "SAYCAM_analysis_dec2019"
author: "Bria Long"
date: "12/4/2019"
output: html_document
---

# Basic data loading and setup
## Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(assertthat)
library(ggthemes)
library(lme4)
library(langcog)
library(viridis)
library(magick)
library(stringr)
library(egg)
theme_set(theme_few())
```

## Read in data 
### Could do list of detections (takes forever, skipping)
```{r eval=FALSE}
data_file = "../data/all_frames.csv"
detections=read.csv(data_file) 
```

### Instead load in detections and ketan's gold set annotations from preprocessed Rdata files
```{r}
load('../data/openpose_detections.RData')
load('../data/ketan_gold_sample.RData')
```
### Load file to filter flipped videos (when sam's mom was wearing camera; not egocentric)
```{r}
right_side_up_file = "../data/video_right-side-up.csv"
right_side_up =read.csv(right_side_up_file)

# get INCORRECT videos
flipped_videos <- right_side_up %>%
  filter(right_side_up==1)
```

### Read in turk anotation data  and merge
#### First read in hand/face present only here, ~4K images
```{r}
turk_annotations = "../data/turk_annotations_dec5.csv" # 20 turkers who did ~250 frames each
gold_set = read.csv(turk_annotations)

## cleanup these goldset annotations so we can merge
g <- gold_set %>%
  filter(is.na(sanity_check_category)) %>% # don't consider sanity check images here
  filter(!is.na(hands)) %>%
  filter(!is.na(faces)) %>%
  mutate(sample_ind = str_split_fixed(short_image_path,"-",3)[,1], frame_ind_temp = str_split_fixed(short_image_path,"-",3)[,3], vid_name_temp = str_split_fixed(short_image_path,"-",3)[,2]) %>%
  mutate(sample_ind = as.numeric(sample_ind), frame_ind = as.numeric(str_split_fixed(frame_ind_temp,".jpg",3)[,1])) %>%
  filter(!is.na(sample_ind))  %>% 
  rowwise() %>%
  mutate(vid_name_short = str_split(vid_name_temp,"[.]")[[1]][1]) %>%
  mutate(vid_name = str_split_fixed(vid_name_temp,".mp4",2)[,1]) %>% ## includes .avi as does detections structure
  filter(!vid_name_short %in% flipped_videos$video) 
  
# length(unique(g$vid_name))  (checking this is >1)

## standardize for merging with detectinos
g$frame = g$frame_ind

```

### Now merge gold set turk annotations and openpose detections
```{r}
# no_openpose <- merged %>%
#   filter(is.na(face_openpose))
# 
# ## never run on openpose?
# unique(no_openpose$vid_name)
# "A_20150507_3124_01"

merged <- g %>%
  left_join(detections)  %>%
  filter(!is.na(face_openpose))
```

### Could also import segmentations (this is only a small sample of 200 frames right now)
```{r eval=FALSE}
turk_annotations_seg = "../data/turk_segmentations_dec12.csv" # 20 turkers who did ~250 frames each
gold_set_seg = read.csv(turk_annotations_seg)
g_seg <- gold_set_seg %>%
  mutate(hands_seg = (label %in% c("Child hand","Adult hand")), face_seg = (label == "Face")) %>%
  mutate(short_image_path = str_split_fixed(full_image_path,'/',7)[,7]) %>%
  mutate(sample_ind = str_split_fixed(short_image_path,"-",3)[,1], frame_ind_temp = str_split_fixed(short_image_path,"-",3)[,3], vid_name_temp = str_split_fixed(short_image_path,"-",3)[,2]) %>%
  mutate(sample_ind = as.numeric(sample_ind), frame_ind = as.numeric(str_split_fixed(frame_ind_temp,".jpg",3)[,1])) %>%
  rowwise() %>%
  mutate(vid_name_short = str_split(vid_name_temp,"[.]")[[1]][1]) %>%
  mutate(vid_name = str_split_fixed(vid_name_temp,".mp4",2)[,1]) 

## And merge with detections
merged_g_seg <- g_seg %>%
  mutate(frame = frame_ind) %>%
  left_join(detections)
```

# Evaluate overall detector performance

## Set-up necessary for p/r/f calculations 
### Write functions to compute TP/FN/TN/FP
```{r}
# Function to evaluate detectors
evaluate_detector <- function(truth, detection) {
  if (truth == TRUE) {
    if (truth == detection) return ("TP") # was face/wrist, detected face/wrist
    else return("FN") # was face/wrist, missed face/wrist
  }
  else {
    if (truth == detection) return("TN") # was not face/wrist, did not detect face/wrist
    else return("FP") # was not face/wrist, detected face/wrist
  }
}

```

### Compute TP/FN/TN/FP on dataset for both faces and hands
```{r}
m <- merged %>%
  select(vid_name, frame, response, hands, faces, sample_ind, face_openpose, hand_openpose, short_image_path, full_image_path, age_days, child_id) %>%
  mutate(face_openpose = as.logical(face_openpose), hand_openpose = as.logical(hand_openpose)) %>%
  rowwise() %>%
  mutate(face_eval = evaluate_detector(faces, face_openpose), hand_eval = evaluate_detector(hands, hand_openpose))
```

### Compute TP/FN/TN/FP on dataset for both faces and hands from segmentation hits (skipping for now)
```{r eval=FALSE}
m_seg <- merged_g_seg %>%
  select(vid_name, frame, label, hands_seg, face_seg, sample_ind, face_openpose, hand_openpose, short_image_path, full_image_path, age_days, child_id) %>%
  mutate(face_openpose = as.logical(face_openpose), hand_openpose = as.logical(hand_openpose)) %>%
  rowwise() %>%
  mutate(face_eval = evaluate_detector(face_seg, face_openpose), hand_eval = evaluate_detector(hands_seg, hand_openpose))

```

### Write functions for returning prfs/f-scores
```{r}
 return_prf_short = function(eval){
  tp=sum(eval == "TP")
  fp=sum(eval == "FP")
  fn=sum(eval == "FN")
  p = tp / (tp + fp)
  r = tp / (tp + fn)
  f=( 2 * p * r )/ (p + r)
  return(c(p,r,f))
 }

 return_fscore = function(eval){
  tp=sum(eval == "TP")
  fp=sum(eval == "FP")
  fn=sum(eval == "FN")
  p = tp / (tp + fp)
  r = tp / (tp + fn)
  f=( 2 * p * r )/ (p + r)
  return(f)
}
```

### Preprocess ketan's annotation, evaluate, and get prfs
```{r}
 ketan_gold_out <- ketan_gold %>%
   rowwise() %>%
   mutate(vid_name = str_split_fixed(vid_name,".mp4",2)[,1])%>%
   mutate(vid_name_short = str_split(vid_name,"[.]")[[1]][1]) %>%
   mutate(face_openpose = as.logical(face_openpose), hand_openpose = as.logical(hand_openpose)) %>%
   rename(face_present_ketan = face_present, hand_present_ketan = hand_present)

 out <- ketan_gold_out %>%
   mutate(face_eval_ketan = evaluate_detector(face_present_ketan, face_openpose), hand_eval_ketan = evaluate_detector(hand_present_ketan, hand_openpose))
```

## Detector evaluation results
### Faces (full 24K)
```{r}
return_prf_short(out$face_eval_ketan)
```
### Faces (full 24K)
```{r}
return_prf_short(out$hand_eval_ketan)
```

### How do f-scores from ketan's gold set hange when we get rid of the flipped videos?
```{r}
out_no_flipped <- ketan_gold_out %>%
  mutate(face_eval_ketan = evaluate_detector(face_present_ketan, face_openpose), hand_eval_ketan = evaluate_detector(hand_present_ketan, hand_openpose))  %>%
  filter(!vid_name_short %in% flipped_videos$video)
```

### Faces (filtered)
```{r}
return_prf_short(out_no_flipped$face_eval_ketan)
```
### Hands (filtered)
```{r}
return_prf_short(out_no_flipped$hand_eval_ketan)
```

### How well do ketan and turkers agree? 
```{r}
ketan_vs_turk <- ketan_gold_out %>%
  left_join(m) %>%
  mutate(turk_vs_ketan_face = (face_present_ketan == faces))

##
agreement = mean(ketan_vs_turk$turk_vs_ketan_face, na.rm=TRUE)
num_examples = sum(!is.na(ketan_vs_turk$turk_vs_ketan_face))

```
Ketan & turkers agreed `r agreement` percent of the time for the `r num_examples` we tested.

## Analyze how detector performance might vary by child/age
### First merge age/child information from other dataframe back into ketan's gold set by frame/vid_name
```{r}
vid_info <- detections %>%
  select(vid_name, frame, age_days, child_id) 

d <- ketan_gold_out %>%
  filter(!vid_name_short %in% flipped_videos$video) %>%
  left_join(vid_info, by=c("vid_name","frame"))
```

### Bin gold set performance every so often (e.g., 10 days)
```{r}
bin_size = 10
min_age = min(d$age_days)
max_age = max(d$age_days)
bin_starts = seq(min_age-1, max_age+1,bin_size)
bins = c(bin_starts, max_age)
d <- d %>%
  mutate(age_day_bin = cut(age_days, bins, labels=round(bin_starts/30,1)))

```

### Look at prf changes by age/child
```{r}
 return_prf = function(eval){
  tp=sum(eval == "TP")
  fp=sum(eval == "FP")
  fn=sum(eval == "FN")
  p = tp / (tp + fp)
  r = tp / (tp + fn)
  f=( 2 * p * r )/ (p + r)
  num_detect = length(eval)
  out <- data.frame(p,r,f,num_detect)
  return(out)
 }

prf_by_age_faces <- d %>%
  mutate(face_eval_ketan = evaluate_detector(face_present_ketan, face_openpose)) %>%
  group_by(age_day_bin, child_id) %>%
  do(return_prf(.$face_eval_ketan))

prf_by_age_hands <- d %>%
  mutate(hand_eval_ketan = evaluate_detector(hand_present_ketan, hand_openpose)) %>%
  group_by(age_day_bin, child_id) %>%
  do(return_prf(.$hand_eval_ketan))
```

### Plot p/r/f/ by age/child for goldset annotations for FACES
```{r}
prf_by_age_faces$age_day_bin = as.numeric(prf_by_age_faces$age_day_bin)


p1  = ggplot(prf_by_age_faces, aes(x=age_day_bin, y=f, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth()  +
  ylab('F-score - Face detection')


p2 = ggplot(prf_by_age_faces, aes(x=age_day_bin, y=r, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth() +
  ylab('Precision - Face detection')

p3 =ggplot(prf_by_age_faces, aes(x=age_day_bin, y=p, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth()  +
  ylab('Recall - Face detection')
#
ggarrange(p1,p2,p3)
```

### Plot p/r/f/ by age/child for goldset annotations for HANDS
```{r}
prf_by_age_hands$age_day_bin = as.numeric(prf_by_age_hands$age_day_bin)

p4  = ggplot(prf_by_age_hands, aes(x=age_day_bin, y=f, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth()  +
  ylab('F-score - Hand detection')

p5 = ggplot(prf_by_age_hands, aes(x=age_day_bin, y=r, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth() +
  ylab('Recall - Hand detection')

p6 =ggplot(prf_by_age_hands, aes(x=age_day_bin, y=p, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth() +
  ylab('Precision - Hand detection')
#
ggarrange(p4,p5,p6)
```


### Look at proportion of hands vs. faces in manual annotations
```{r}
face_vs_hands_goldset <- d %>%
  group_by(child_id, age_day_bin) %>%
  summarize(prop_faces = sum(face_present_ketan) / length(face_present_ketan), prop_hands = sum(hand_present_ketan) / length(hand_present_ketan), num_detect = length(face_present_ketan)) %>%
  mutate(faces_vs_hands = prop_faces - prop_hands)

face_vs_hands_goldset$age_day_bin  = as.numeric(face_vs_hands_goldset$age_day_bin)

ggplot(face_vs_hands_goldset, aes(x=age_day_bin, y=faces_vs_hands, col=child_id, size=num_detect)) +
  geom_point(alpha=.5) +
  geom_smooth() +
  ylab("Faces - Hands (manual annotations)")

```


# Examine age-trends in fullset of open-pose detections
## Preprocess detections data


### Make detections into logical vectors and compute "person" as either face/hand
```{r}
d_all <- detections
d_all$face_openpose = as.logical(d_all$face_openpose)
d_all$hand_openpose = as.logical(d_all$hand_openpose)
d_all$person_openpose = (as.logical(d_all$face_openpose) | as.logical(d_all$hand_openpose))
d_all$both_openpose = (as.logical(d_all$face_openpose) & as.logical(d_all$hand_openpose))

```

### Make age bins and compute summary statistics
```{r}

# Can redo this but using same bins as in gold set comparison
# bin_size = 10
# min_age = min(d$age_days)
# max_age = max(d$age_days)
# bin_starts = seq(min_age-1, max_age+1,bin_size)
# bins = c(bin_starts, max_age)
# d <- d %>%
#   mutate(age_day_bin = cut(age_days, bins, labels=round(bin_starts/30,1)))

summary_by_age <- d_all %>%
  mutate(age_day_bin = cut(age_days, bins, labels=round(bin_starts/bin_size,1))) %>%
  group_by(age_day_bin, child_id) %>%
  summarize(num_detect = length(face_openpose), prop_faces = sum(face_openpose) / num_detect,  prop_hands = sum(hand_openpose) / num_detect, face_or_hand = sum(person_openpose)/ num_detect, face_and_hand = sum(both_openpose)/ num_detect) 


# need numeric on age bins for geom_smooth...
summary_by_age$age_day_bin=as.numeric(summary_by_age$age_day_bin)

```
  
## Make diagnotic plots over age from all detections
### Faces
```{r}
ggplot(summary_by_age, aes(x=age_day_bin, y=prop_faces, size=num_detect, col=child_id)) +
  geom_point(alpha=.8) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  geom_smooth() + 
  ylab('Proportion Faces') + 
  xlab('Age bin')
```

### Hands
```{r}
ggplot(summary_by_age, aes(x=age_day_bin, y=prop_hands, size=num_detect, col=child_id)) +
  geom_point(alpha=.8) +
  geom_smooth() + 
  ylab('Proportion Hands') + 
  xlab('Age bin')
```


### Faces - Hands: Key plot for fausey comparison
```{r}
## faces - hands
ggplot(summary_by_age, aes(x=age_day_bin, y=prop_faces - prop_hands, size=num_detect, col=child_id)) +
  geom_point(alpha=.8) +
  geom_smooth() + 
  ylab('Proportion Faces - Hands') + 
  xlab('Age bin')


```

### Face OR hand
```{r}
ggplot(summary_by_age, aes(x=age_day_bin, y=face_or_hand, size=num_detect, col=child_id)) +
  geom_point(alpha=.8) +
  geom_smooth() + 
  ylab('Proportion Face OR Hand') + 
  xlab('Age bin')
```

### Face AND Hand
```{r}
ggplot(summary_by_age, aes(x=age_day_bin, y=face_and_hand, size=num_detect, col=child_id)) +
  geom_point(alpha=.8) +
  geom_smooth() + 
  ylab('Proportion Face AND Hand') + 
  xlab('Age bin')
```



# Render out images based on annotations if desired
## True positives on faces?
```{r eval=FALSE}
faces_only_op_cor <- m %>%
  filter(faces == TRUE) %>%
  filter(face_openpose == TRUE)

# how about images where open pose got it? these should be most obvious
dir.create(paste0('faces_tp/'))
for (i in seq(1,length(faces_only_op_cor$full_image_path),1)){
  image_read(as.character(faces_only_op_cor$full_image_path[i])) %>%
  image_append(stack = FALSE) %>%
  image_write(file.path(paste0("faces_tp/", faces_only_op_cor$short_image_path[i])))
}

```

## False positives on facs?
```{r eval=FALSE}
to_write <- m %>%
  filter(faces == FALSE) %>%
  filter(face_openpose == TRUE)

# how about images where open pose got it? these should be most obvious
dir.create(paste0('faces_fp/'))
for (i in seq(1,length(to_write$full_image_path),1)){
  image_read(as.character(to_write$full_image_path[i])) %>%
  image_append(stack = FALSE) %>%
  image_write(file.path(paste0("faces_fp/", to_write$short_image_path[i])))
}

```


## False negatives on faces?
```{r eval=FALSE}
to_write <- m %>%
  filter(faces == TRUE) %>%
  filter(face_openpose == FALSE)

# how about images where open pose got it? these should be most obvious
dir.create(paste0('faces_fn/'))
for (i in seq(1,length(to_write$full_image_path),1)){
  image_read(as.character(to_write$full_image_path[i])) %>%
  image_append(stack = FALSE) %>%
  image_write(file.path(paste0("faces_fn/", to_write$short_image_path[i])))
}

```
